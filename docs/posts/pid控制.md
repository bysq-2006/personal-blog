---
date: 2026-1-13
category:
  - ç¡¬ä»¶ç›¸å…³
title: PIDæ§åˆ¶åŸç†åŠåº”ç”¨
---

## ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜
åœ¨è‡ªåŠ¨æ§åˆ¶ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•ä½¿è¢«æ§å¯¹è±¡ï¼ˆå¦‚æ¸©åº¦ã€é€Ÿåº¦ã€ä½ç½®ç­‰ï¼‰è¾¾åˆ°å¹¶ç»´æŒåœ¨è®¾å®šå€¼æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚PIDæ§åˆ¶å™¨é€šè¿‡è°ƒèŠ‚æ§åˆ¶å˜é‡æ¥å®ç°è¿™ä¸€ç›®æ ‡ï¼Œç¡®ä¿ç³»ç»Ÿå“åº”è¿…é€Ÿä¸”ç¨³å®šï¼Œå‡å°‘è¶…è°ƒå’ŒæŒ¯è¡ç°è±¡ã€‚

æ›´å…·ä½“çš„è¯´ï¼Œå¯¹äºå•ä¸€çš„ä¸€ä¸ªå¯ä»¥é‡åŒ–çš„ç‰©ç†é‡ï¼Œæˆ‘ä»¬åªèƒ½æ§åˆ¶ä¸€ä¸ªé—´æ¥å½±å“è¿™ä¸ªç‰©ç†é‡çš„å€¼ï¼Œå¹¶å¸Œæœ›å®ƒèƒ½è¾¾åˆ°ä¸€ä¸ªç›®æ ‡å€¼ï¼Œå¹¶ä¸”åœ¨è¾¾åˆ°ç›®æ ‡å€¼åèƒ½å¤Ÿç¨³å®šä¸‹æ¥ï¼Œä¸ä¼šå› ä¸ºå¤–ç•Œæ‰°åŠ¨æˆ–ç³»ç»Ÿæœ¬èº«çš„å˜åŒ–è€Œåç¦»ç›®æ ‡å€¼ã€‚PIDæ§åˆ¶å™¨é€šè¿‡å¯¹è¯¯å·®è¿›è¡Œè®¡ç®—å’Œè°ƒæ•´ï¼Œå¸®åŠ©å®ç°è¿™ä¸€ç›®æ ‡ã€‚

## ä»ç¬¬ä¸€æ­¥å¼€å§‹
å‡å¦‚ç°åœ¨å­˜åœ¨ä¸€ä¸ªæ— äººæœºï¼Œæˆ‘ä»¬éœ€è¦å®ƒåœåœ¨ç©ºä¸­30må¤„ï¼Œè€Œæˆ‘ä»¬å”¯ä¸€å¯ä»¥åšçš„æ˜¯æ§åˆ¶å®ƒçš„æ¨è¿›å™¨æ¨åŠ›å¤§å°ã€‚

å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ï¼Œå¦‚æœæˆ‘ä»¬æ£€æµ‹åˆ°å½“å‰æ— äººæœºçš„é«˜åº¦å°äº30mï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¢åŠ æ¨åŠ›ï¼Œåä¹‹åˆ™å‡å°‘æ¨åŠ›ã€‚
ä½†æ˜¯è¿™æ ·åšä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå‡è®¾æ— äººæœºå½“å‰é«˜åº¦ä¸º20mï¼Œæˆ‘ä»¬å¢åŠ æ¨åŠ›è®©å®ƒä¸Šå‡ï¼Œå½“å®ƒè¾¾åˆ°30mæ—¶ï¼Œæˆ‘ä»¬åˆå‡å°‘æ¨åŠ›è®©å®ƒä¸‹é™ã€‚ç”±äºæƒ¯æ€§çš„ä½œç”¨ï¼Œæ— äººæœºä¼šç»§ç»­ä¸Šå‡åˆ°è¶…è¿‡30mçš„é«˜åº¦ï¼Œç„¶åæˆ‘ä»¬åˆå¢åŠ æ¨åŠ›è®©å®ƒä¸‹é™ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ— äººæœºå°±ä¼šåœ¨30mä¸Šä¸‹æŒ¯è¡ï¼Œæ— æ³•ç¨³å®šåœ¨ç›®æ ‡é«˜åº¦ã€‚

åšä¸€ä¸ªå°ä¼˜åŒ–ï¼Œæˆ‘ä»¬è®©æ¨åŠ›çš„å¢åŠ å’Œå‡å°‘ä¸å½“å‰é«˜åº¦å’Œç›®æ ‡é«˜åº¦çš„å·®å€¼æˆæ­£æ¯”ã€‚è¿™æ ·ä¸€æ¥ï¼Œå½“æ— äººæœºæ¥è¿‘30mæ—¶ï¼Œæ¨åŠ›çš„è°ƒæ•´ä¼šå˜å¾—æ›´å°ï¼Œä»è€Œå‡å°‘æŒ¯è¡çš„å¹…åº¦ã€‚

é‚£ä¹ˆï¼Œå½“å‰æ¨åŠ›**F = Kp * (ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦)**

æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªç¤ºä¾‹ï¼š

<!-- åœºæ™¯ 1: P æ§åˆ¶å™¨ -->
<div class="scenario-section">
  <div class="scenario-header">
    <h3>{{ drones[0].label }}</h3>
    <p class="desc">{{ drones[0].description }}</p>
    <div class="local-controls">
        <button class="primary small" v-if="!drones[0].isRunning" @click="toggleDrone(drones[0])">â–¶ å¼€å§‹</button>
        <button class="warning small" v-else @click="toggleDrone(drones[0])">â¸ æš‚åœ</button>
        <button class="danger small" @click="resetDrone(drones[0])">â†º é‡ç½®</button>
    </div>
  </div>
  <div class="scenario-body">
    <div class="params-editor">
      <div class="param-row">
        <span class="label">Kp</span>
        <input type="range" min="0" max="20" step="0.1" v-model.number="drones[0].kp">
        <span class="val">{{ drones[0].kp.toFixed(1) }}</span>
      </div>
    </div>
    <div class="dashboard-row">
      <div class="world-view">
        <div class="target-line" :style="{ bottom: (TARGET_HEIGHT * 4) + 'px' }">30m</div>
        <div class="drone-sprite" :style="{ bottom: (drones[0].height * 4) + 'px' }">
          ğŸš
          <div class="flame" :style="{ opacity: Math.min(Math.abs(drones[0].lastOutput) / 50, 1) }">ğŸ”¥</div>
        </div>
        <div class="height-text">{{ drones[0].height.toFixed(1) }}m</div>
      </div>
      <div class="chart-view">
        <svg width="100%" height="100%" viewBox="0 0 400 200" preserveAspectRatio="none">
          <rect width="400" height="200" fill="#fcfcfc" />
          <line x1="0" :y1="targetLineY" x2="400" :y2="targetLineY" stroke="#4CAF50" stroke-dasharray="4" />
          <polyline :points="getPoints(drones[0].history)" fill="none" stroke="#2196F3" stroke-width="2" />
        </svg>
      </div>
    </div>
  </div>
  <div class="info-footer">
    <span>æ¨åŠ›: {{ drones[0].lastOutput.toFixed(1) }} N</span>
    <span>é€Ÿåº¦: {{ drones[0].velocity.toFixed(1) }} m/s</span>
  </div>
</div>

å¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°ï¼Œè¦ä¹ˆkpå¤ªå°ï¼Œæ— æ³•å…‹æœé‡åŠ›å¯¼è‡´æ— äººæœºæ— æ³•å‡åˆ°30mï¼›è¦ä¹ˆkpå¤ªå¤§ï¼Œå¯¼è‡´æ— äººæœºåœ¨30mä¸Šä¸‹æŒ¯è¡ã€‚
é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è®©æ— äººæœºç¨³å®šåœ¨30må¤„å‘¢ï¼Ÿ

## å¼•å…¥ç§¯åˆ†é¡¹ (I)
æˆ‘ä»¬å…ˆå¤„ç†kpå¤ªå°çš„æƒ…å†µã€‚å‡è®¾æ— äººæœºè¾¾åˆ°äº†ä¸€ä¸ªç¨³å®šé«˜åº¦25mï¼Œè™½ç„¶æ²¡æœ‰è¾¾åˆ°30mï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°æ— äººæœºåœ¨25må¤„æ˜¯é™æ­¢çš„ï¼Œè¯´æ˜æ­¤æ—¶æ¨åŠ›å’Œé‡åŠ›
è¾¾åˆ°äº†å¹³è¡¡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥ä¸€ä¸ªç§¯åˆ†é¡¹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ç§¯åˆ†é¡¹çš„ä½œç”¨æ˜¯ç´¯ç§¯è¿‡å»çš„è¯¯å·®ï¼Œå½“æ— äººæœºæ— æ³•è¾¾åˆ°ç›®æ ‡é«˜åº¦æ—¶ï¼Œç§¯åˆ†é¡¹ä¼šä¸æ–­å¢åŠ ï¼Œä»è€Œå¢åŠ æ¨åŠ›ï¼Œç›´åˆ°æ— äººæœºè¾¾åˆ°ç›®æ ‡é«˜åº¦ä¸ºæ­¢ã€‚

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å½“å‰æ¨åŠ›ä¸ºï¼š<br>
**F = Kp * (ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦) + Ki * âˆ«(ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦) dt**

<!-- åœºæ™¯ 2: PI æ§åˆ¶å™¨ -->
<div class="scenario-section">
  <div class="scenario-header">
    <h3>{{ drones[1].label }}</h3>
    <p class="desc">{{ drones[1].description }}</p>
    <div class="local-controls">
        <button class="primary small" v-if="!drones[1].isRunning" @click="toggleDrone(drones[1])">â–¶ å¼€å§‹</button>
        <button class="warning small" v-else @click="toggleDrone(drones[1])">â¸ æš‚åœ</button>
        <button class="danger small" @click="resetDrone(drones[1])">â†º é‡ç½®</button>
    </div>
  </div>
  <div class="scenario-body">
    <div class="params-editor">
      <div class="param-row">
        <span class="label">Kp</span>
        <input type="range" min="0" max="20" step="0.1" v-model.number="drones[1].kp">
        <span class="val">{{ drones[1].kp.toFixed(1) }}</span>
      </div>
      <div class="param-row">
        <span class="label">Ki</span>
        <input type="range" min="0" max="10" step="0.01" v-model.number="drones[1].ki">
        <span class="val">{{ drones[1].ki.toFixed(2) }}</span>
      </div>
    </div>
    <div class="dashboard-row">
      <div class="world-view">
        <div class="target-line" :style="{ bottom: (TARGET_HEIGHT * 4) + 'px' }">30m</div>
        <div class="drone-sprite" :style="{ bottom: (drones[1].height * 4) + 'px' }">
          ğŸš
          <div class="flame" :style="{ opacity: Math.min(Math.abs(drones[1].lastOutput) / 50, 1) }">ğŸ”¥</div>
        </div>
        <div class="height-text">{{ drones[1].height.toFixed(1) }}m</div>
      </div>
      <div class="chart-view">
        <svg width="100%" height="100%" viewBox="0 0 400 200" preserveAspectRatio="none">
          <rect width="400" height="200" fill="#fcfcfc" />
          <line x1="0" :y1="targetLineY" x2="400" :y2="targetLineY" stroke="#4CAF50" stroke-dasharray="4" />
          <polyline :points="getPoints(drones[1].history)" fill="none" stroke="#2196F3" stroke-width="2" />
        </svg>
      </div>
    </div>
  </div>
  <div class="info-footer">
    <span>æ¨åŠ›: {{ drones[1].lastOutput.toFixed(1) }} N</span>
    <span>é€Ÿåº¦: {{ drones[1].velocity.toFixed(1) }} m/s</span>
  </div>
</div>

å¾ˆæ˜æ˜¾ï¼Œç¨³æ€è¯¯å·®è¢«æ¶ˆé™¤äº†ï¼Œæ— äººæœºèƒ½å¤Ÿç¨³å®šåœ¨30må¤„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ— äººæœºçš„éœ‡è¡å˜å¾—æ›´åŠ ä¸¥é‡äº†ã€‚è¿™æ˜¯å› ä¸ºiä¼šå­˜å‚¨çŠ¶æ€ï¼Œå¯¼è‡´ç³»ç»Ÿæƒ¯æ€§å˜å¤§ã€‚

## å¼•å…¥å¾®åˆ†é¡¹ (D)
ä¸ºäº†å‡å°‘æŒ¯è¡ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥å¾®åˆ†é¡¹ã€‚å¾®åˆ†é¡¹çš„ä½œç”¨æ˜¯é¢„æµ‹æœªæ¥çš„è¯¯å·®å˜åŒ–è¶‹åŠ¿ï¼Œä»è€Œæå‰è°ƒæ•´æ¨åŠ›ï¼Œå‡å°‘æŒ¯è¡ã€‚

è¯´äººè¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªé˜»å°¼ï¼Œä¼šå‘ç€é€Ÿåº¦çš„åæ–¹å‘æ–½åŠ åŠ›ï¼Œä»è€Œå‡ç¼“æ— äººæœºçš„è¿åŠ¨ã€‚è€ŒåŠ›çš„å¤§å°ä¸é€Ÿåº¦æˆæ­£æ¯”ã€‚

ä¸è¿‡ï¼Œæˆ‘ä»¬ç°åœ¨å…ˆä¸å¼•å…¥iï¼Œå…ˆçœ‹çœ‹pdæ§åˆ¶å™¨çš„ç¼ºé™·ã€‚

å…¬å¼ï¼š<br>
**F = Kp * (ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦) + Kd * d(ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦)/dt**

<!-- åœºæ™¯ 3: PD æ§åˆ¶å™¨ -->
<div class="scenario-section">
  <div class="scenario-header">
    <h3>{{ drones[2].label }}</h3>
    <p class="desc">{{ drones[2].description }}</p>
    <div class="local-controls">
        <button class="primary small" v-if="!drones[2].isRunning" @click="toggleDrone(drones[2])">â–¶ å¼€å§‹</button>
        <button class="warning small" v-else @click="toggleDrone(drones[2])">â¸ æš‚åœ</button>
        <button class="danger small" @click="resetDrone(drones[2])">â†º é‡ç½®</button>
    </div>
  </div>
  <div class="scenario-body">
    <div class="params-editor">
      <div class="param-row">
        <span class="label">Kp</span>
        <input type="range" min="0" max="20" step="0.1" v-model.number="drones[2].kp">
        <span class="val">{{ drones[2].kp.toFixed(1) }}</span>
      </div>
      <div class="param-row">
        <span class="label">Kd</span>
        <input type="range" min="0" max="50" step="0.5" v-model.number="drones[2].kd">
        <span class="val">{{ drones[2].kd.toFixed(1) }}</span>
      </div>
    </div>
    <div class="dashboard-row">
      <div class="world-view">
        <div class="target-line" :style="{ bottom: (TARGET_HEIGHT * 4) + 'px' }">30m</div>
        <div class="drone-sprite" :style="{ bottom: (drones[2].height * 4) + 'px' }">
          ğŸš
          <div class="flame" :style="{ opacity: Math.min(Math.abs(drones[2].lastOutput) / 50, 1) }">ğŸ”¥</div>
        </div>
        <div class="height-text">{{ drones[2].height.toFixed(1) }}m</div>
      </div>
      <div class="chart-view">
        <svg width="100%" height="100%" viewBox="0 0 400 200" preserveAspectRatio="none">
          <rect width="400" height="200" fill="#fcfcfc" />
          <line x1="0" :y1="targetLineY" x2="400" :y2="targetLineY" stroke="#4CAF50" stroke-dasharray="4" />
          <polyline :points="getPoints(drones[2].history)" fill="none" stroke="#2196F3" stroke-width="2" />
        </svg>
      </div>
    </div>
  </div>
  <div class="info-footer">
    <span>æ¨åŠ›: {{ drones[2].lastOutput.toFixed(1) }} N</span>
    <span>é€Ÿåº¦: {{ drones[2].velocity.toFixed(1) }} m/s</span>
  </div>
</div>

å¯ä»¥çœ‹åˆ°ï¼ŒæŒ¯è¡å¾—åˆ°äº†æ˜æ˜¾çš„æ”¹å–„ï¼Œæ— äººæœºèƒ½å¤Ÿæ›´å¿«åœ°ç¨³å®šåœ¨30må¤„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ— äººæœºæ— æ³•å®Œå…¨è¾¾åˆ°30mï¼Œå­˜åœ¨ä¸€ä¸ªå°çš„ç¨³æ€è¯¯å·®ã€‚

## ç»“åˆä¸‰è€…ï¼šPID æ§åˆ¶å™¨
æœ€åï¼Œæˆ‘ä»¬å°†ä¸‰è€…ç»“åˆèµ·æ¥ï¼Œå½¢æˆPIDæ§åˆ¶å™¨ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬æ—¢èƒ½æ¶ˆé™¤ç¨³æ€è¯¯å·®ï¼Œåˆèƒ½å‡å°‘æŒ¯è¡ã€‚
å…¬å¼ï¼š<br>
**F = Kp * (ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦) + Ki * âˆ«(ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦) dt + Kd * d(ç›®æ ‡é«˜åº¦ - å½“å‰é«˜åº¦)/dt**

<!-- åœºæ™¯ 4: PID æ§åˆ¶å™¨ -->
<div class="scenario-section">
  <div class="scenario-header">
    <h3>{{ drones[3].label }}</h3>
    <p class="desc">{{ drones[3].description }}</p>
    <div class="local-controls">
        <button class="primary small" v-if="!drones[3].isRunning" @click="toggleDrone(drones[3])">â–¶ å¼€å§‹</button>
        <button class="warning small" v-else @click="toggleDrone(drones[3])">â¸ æš‚åœ</button>
        <button class="danger small" @click="resetDrone(drones[3])">â†º é‡ç½®</button>
    </div>
  </div>
  <div class="scenario-body">
    <div class="params-editor">
      <div class="param-row">
        <span class="label">Kp</span>
        <input type="range" min="0" max="20" step="0.1" v-model.number="drones[3].kp">
        <span class="val">{{ drones[3].kp.toFixed(1) }}</span>
      </div>
      <div class="param-row">
        <span class="label">Ki</span>
        <input type="range" min="0" max="10" step="0.01" v-model.number="drones[3].ki">
        <span class="val">{{ drones[3].ki.toFixed(2) }}</span>
      </div>
      <div class="param-row">
        <span class="label">Kd</span>
        <input type="range" min="0" max="50" step="0.5" v-model.number="drones[3].kd">
        <span class="val">{{ drones[3].kd.toFixed(1) }}</span>
      </div>
    </div>
    <div class="dashboard-row">
      <div class="world-view">
        <div class="target-line" :style="{ bottom: (TARGET_HEIGHT * 4) + 'px' }">30m</div>
        <div class="drone-sprite" :style="{ bottom: (drones[3].height * 4) + 'px' }">
          ğŸš
          <div class="flame" :style="{ opacity: Math.min(Math.abs(drones[3].lastOutput) / 50, 1) }">ğŸ”¥</div>
        </div>
        <div class="height-text">{{ drones[3].height.toFixed(1) }}m</div>
      </div>
      <div class="chart-view">
        <svg width="100%" height="100%" viewBox="0 0 400 200" preserveAspectRatio="none">
          <rect width="400" height="200" fill="#fcfcfc" />
          <line x1="0" :y1="targetLineY" x2="400" :y2="targetLineY" stroke="#4CAF50" stroke-dasharray="4" />
          <polyline :points="getPoints(drones[3].history)" fill="none" stroke="#2196F3" stroke-width="2" />
        </svg>
      </div>
    </div>
  </div>
  <div class="info-footer">
    <span>æ¨åŠ›: {{ drones[3].lastOutput.toFixed(1) }} N</span>
    <span>é€Ÿåº¦: {{ drones[3].velocity.toFixed(1) }} m/s</span>
  </div>
</div>

æ•ˆæœéå¸¸æ˜æ˜¾ï¼ŒPIDæ§åˆ¶å™¨èƒ½å¤Ÿè®©æ— äººæœºå¿«é€Ÿä¸”ç¨³å®šåœ°è¾¾åˆ°30mé«˜åº¦ï¼Œå¹¶ä¸”å‡ ä¹æ²¡æœ‰æŒ¯è¡ã€‚

## ä¸€äº›æƒ³æ³•
è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç†æƒ³åŒ–çš„åœºæ™¯ï¼Œå®é™…åº”ç”¨ä¸­ï¼ŒPIDæ§åˆ¶å™¨çš„è°ƒå‚æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å…·ä½“ç³»ç»Ÿçš„åŠ¨æ€ç‰¹æ€§è¿›è¡Œè°ƒæ•´ã€‚

å¹¶ä¸”ï¼Œpidåªèƒ½åœ¨å•å˜é‡æ§åˆ¶ä¸­ä½¿ç”¨ï¼Œå¯¹äºå¤šå˜é‡æ§åˆ¶ç³»ç»Ÿï¼Œéœ€è¦ä½¿ç”¨æ›´å¤æ‚çš„æ§åˆ¶ç®—æ³•ï¼Œå¦‚çŠ¶æ€ç©ºé—´æ§åˆ¶ã€æ¨¡å‹é¢„æµ‹æ§åˆ¶ç­‰ã€‚

æˆ–è€…ï¼Œå¦‚æœä¸¤ä¸ªå˜é‡ä¹‹é—´è€¦åˆä¸å¼ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¤šä¸ªpidæ§åˆ¶å™¨åˆ†åˆ«æ§åˆ¶ä¸åŒçš„å˜é‡ã€‚

æ€»ä¹‹ï¼Œç¢°åˆ°éœ€è¦æ§åˆ¶çš„åœºæ™¯æ—¶ï¼Œå¯ä»¥å…ˆè¯•è¯•pidæ§åˆ¶å™¨ï¼Œå¾€å¾€èƒ½å¸¦æ¥ä¸é”™çš„æ•ˆæœã€‚å¦‚æœä¸è¡Œï¼Œå†è€ƒè™‘æ›´å¤æ‚çš„æ§åˆ¶æ–¹æ³•ã€‚

bye

<script setup lang="ts">
import { ref, computed, reactive, onUnmounted } from 'vue'

// Constants
const TARGET_HEIGHT = 30
const GRAVITY = 9.8
const MASS = 1.0

type ControlType = 'P' | 'PI' | 'PD' | 'PID'

interface DroneState {
  id: string
  type: ControlType
  label: string
  description?: string
  isRunning: boolean
  // Tuning Params
  kp: number
  ki: number
  kd: number
  // Physics State
  height: number
  velocity: number
  // Controller State
  integralSum: number
  lastError: number
  // Visualization
  history: {t: number, h: number}[]
  lastOutput: number // To show thrust amount
}

const drones = reactive<DroneState[]>([
  { 
    id: 'p', type: 'P', label: '1. çº¯æ¯”ä¾‹æ§åˆ¶ (P Controller)', 
    description: 'åªæœ‰ Kpã€‚ä¼šäº§ç”Ÿç¨³æ€è¯¯å·®ï¼Œæ— æ³•å®Œå…¨æ¶ˆé™¤é‡åŠ›å½±å“ã€‚',
    isRunning: false,
    kp: 2.0, ki: 0, kd: 0,
    height: 0, velocity: 0, integralSum: 0, lastError: 0, history: [], lastOutput: 0 
  },
  { 
    id: 'pi', type: 'PI', label: '2. æ¯”ä¾‹+ç§¯åˆ†æ§åˆ¶ (PI Controller)', 
    description: 'å¢åŠ  Kiã€‚ç§¯åˆ†é¡¹æ¶ˆé™¤ç¨³æ€è¯¯å·®ï¼Œä½†å¯èƒ½å¼•å…¥ä½é¢‘æŒ¯è¡ã€‚',
    isRunning: false,
    kp: 2.0, ki: 0.5, kd: 0,
    height: 0, velocity: 0, integralSum: 0, lastError: 0, history: [], lastOutput: 0
  },
  { 
    id: 'pd', type: 'PD', label: '3. æ¯”ä¾‹+å¾®åˆ†æ§åˆ¶ (PD Controller)', 
    description: 'å¢åŠ  Kdã€‚å¾®åˆ†é¡¹æä¾›é˜»å°¼ï¼Œå‡å°‘æŒ¯è¡ï¼Œå“åº”æ›´å¿«ï¼Œä½†æ— æ³•æ¶ˆé™¤ç¨³æ€è¯¯å·®ã€‚',
    isRunning: false,
    kp: 2.0, ki: 0, kd: 5.0,
    height: 0, velocity: 0, integralSum: 0, lastError: 0, history: [], lastOutput: 0
  },
  { 
    id: 'pid', type: 'PID', label: '4. PID æ§åˆ¶ (PID Controller)', 
    description: 'ç»“åˆä¸‰è€…ã€‚På“åº”ï¼ŒIæ¶ˆè¯¯ï¼ŒDå‡æŒ¯ã€‚',
    isRunning: false,
    kp: 5.0, ki: 0.5, kd: 10.0,
    height: 0, velocity: 0, integralSum: 0, lastError: 0, history: [], lastOutput: 0
  }
])

const isLoopRunning = ref(false)
let timer: number | null = null
let // simulationTime not used globally in new logic, but kept for compatibility if needed or removed
    simulationTime = 0
let lastTimestamp = 0

// Global Actions (Removed per request)
// Individual Actions
const toggleDrone = (d: DroneState) => {
  d.isRunning = !d.isRunning
  if (d.isRunning) {
    ensureLoopRunning()
  }
}

const resetDrone = (d: DroneState) => {
  d.isRunning = false
  resetThisDrone(d)
}

const resetThisDrone = (d: DroneState) => {
  d.height = 0
  d.velocity = 0
  d.integralSum = 0
  d.lastError = 0
  d.history = []
  d.lastOutput = 0
}

const ensureLoopRunning = () => {
  if (!isLoopRunning.value) {
    isLoopRunning.value = true
    lastTimestamp = performance.now()
    tick()
  }
}

const updateDrone = (drone: DroneState, dt: number) => {
  // Error calculation
  const error = TARGET_HEIGHT - drone.height
  
  // 1. Proportional Term
  const P = drone.kp * error
  
  // 2. Integral Term
  if (drone.type.includes('I')) {
    drone.integralSum += error * dt
  }
  const I = drone.ki * drone.integralSum
  
  // 3. Derivative Term
  let D = 0
  if (drone.type.includes('D')) {
    // Protect against dt=0 just in case, though tick handles it
    if (dt > 0.0001) {
       const derivative = (error - drone.lastError) / dt
       D = drone.kd * derivative
    }
  }
  drone.lastError = error
  
  // Total Thrust
  // User requested reverse thrust allowed (bidirectional thrusters)
  let thrust = P + I + D
  
  drone.lastOutput = thrust

  // Physics F = ma
  const weight = MASS * GRAVITY
  const netForce = thrust - weight
  const acceleration = netForce / MASS
  
  drone.velocity += acceleration * dt
  drone.height += drone.velocity * dt
  
  // Ground collision
  if (drone.height < 0) {
    drone.height = 0
    drone.velocity = -drone.velocity * 0.5 // Bounce
    if (Math.abs(drone.velocity) < 0.1) drone.velocity = 0
  }
  
  // History
  drone.history.push({ t: simulationTime, h: drone.height })
  if (drone.history.length > 500) drone.history.shift()
}

const tick = () => {
  if (!isLoopRunning.value) return

  const now = performance.now()
  const dt = Math.min((now - lastTimestamp) / 1000, 0.1)
  
  // Prevent division by zero or extremely small steps causing instability
  if (dt < 0.001) {
    timer = requestAnimationFrame(tick)
    return
  }
  
  lastTimestamp = now

  simulationTime += dt

  let anyRunning = false
  drones.forEach(d => {
    if (d.isRunning) {
      updateDrone(d, dt)
      anyRunning = true
    }
  })
  
  if (!anyRunning) {
      isLoopRunning.value = false
      timer = null
      return
  }
  
  timer = requestAnimationFrame(tick)
}

// Chart Helper
const getPoints = (history: {t: number, h: number}[]) => {
  if (history.length < 2) return ""
  const width = 400
  const heightPx = 200
  const scaleY = 4 // 50m = 200px -> 1m = 4px
  
  return history.map((pt, index) => {
    const x = (index / (history.length - 1 || 1)) * width
    const y = heightPx - (pt.h * scaleY) 
    return `${x},${y}`
  }).join(' ')
}

const targetLineY = 200 - (TARGET_HEIGHT * 4)

onUnmounted(() => {
  drones.forEach(d => d.isRunning = false)
})
</script>

<style scoped>
.scenario-section {
  background: white;
  border-left: 5px solid #2196F3;
  border-radius: 4px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  padding: 20px;
  margin-bottom: 20px;
}

.scenario-header h3 {
  margin: 0 0 5px 0;
  color: #333;
}
.scenario-header .desc {
  margin: 0 0 10px 0;
  color: #666;
  font-size: 0.9em;
  font-style: italic;
}

.local-controls {
  margin-bottom: 10px;
}

.local-controls button.small {
  padding: 4px 10px;
  font-size: 12px;
  margin-right: 5px;
}

.scenario-body {
  display: flex;
  gap: 20px;
  flex-wrap: wrap; /* On small screens */
}

.params-editor {
  flex: 0 0 180px;
  background: #f8f9fa;
  padding: 15px;
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.param-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}
.param-row:last-child { margin-bottom: 0; }

.param-row .label { width: 30px; font-weight: bold; color: #555; }
.param-row input { flex: 1; min-width: 0; }
.param-row .val { width: 35px; text-align: right; font-family: monospace; font-size: 0.9em; }

.dashboard-row {
  flex: 1;
  display: flex;
  height: 200px;
  gap: 15px;
}

.world-view {
  width: 100px;
  background: linear-gradient(to bottom, #B3E5FC 0%, #E1F5FE 100%);
  position: relative;
  border: 1px solid #ddd;
  border-bottom: 4px solid #795548;
  overflow: hidden;
  border-radius: 4px;
}

.target-line {
  position: absolute;
  width: 100%;
  border-top: 1px dashed #2E7D32;
  color: #2E7D32;
  font-size: 10px;
  text-align: right;
  padding-right: 2px;
}

.drone-sprite {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  font-size: 24px;
  transition: bottom 0.05s linear;
  width: 30px;
  text-align: center;
  line-height: 1;
}

.flame {
  font-size: 14px;
  margin-top: -4px;
  /* Flip if thrust is negative? Na, just scale opacity */
}

.height-text {
  position: absolute;
  top: 5px;
  left: 5px;
  font-size: 11px;
  color: #444;
  background: rgba(255,255,255,0.8);
  padding: 2px 4px;
  border-radius: 2px;
}

.chart-view {
  flex: 1;
  border: 1px solid #eee;
  background: #fcfcfc;
  border-radius: 4px;
}

.info-footer {
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid #eee;
  display: flex;
  gap: 20px;
  color: #666;
  font-size: 0.9em;
}
</style>
