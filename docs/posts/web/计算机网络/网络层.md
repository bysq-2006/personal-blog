---
title: iso 7层模型-网络层
date: 2025-12-24
category:
  - web
  - 计算机网络
---

# 网络层：实现网络互联

网络层是OSI模型的第三层，主要负责将数据包从源主机传输到目的主机，实现不同网络之间的互联。它引入了IP地址的概念，用于标识网络和主机。

## 一些问题
1. 交换机的MAC映射表是有限的，如果连接的计算机过多，可能会导致映射表溢出
2. 如果两台交换机形成一个回环，会导致广播风暴（当一台交换机收到广播包时，会将其转发到所有端口，包括连接另一台交换机的端口，另一台交换机又会将其转发回去，形成无限循环）

所以，我们需要一些新的机制。

- 比如，如果整个世界直接连所有的计算机，那么每一个计算机询问mac都会让整个世界的网络广播一次

所以，划分网络是必要的。

## 划分网络
划分后的网络就像一个村庄，每个村庄有很多房子。

如果村庄里的人想要互相通信，他们需要知道对方住在哪个房子。

在计算机网络中，房子就相当于计算机的地址。

但是我们不能用mac地址来划分网络，
因为mac地址是根据厂商分配的，每个人买回家后分布在世界各地

如果我们想要根据地理位置来划分网络，mac地址就不合适了。

所以我们需要ip地址。

## ip地址
ip地址就是专门为了划分网络而设计的。

ip地址最大的特点，就是它由两部分组成：网络号和主机号。

- 主机号就像村庄里房子的门牌号，标识计算机在网络中的位置
- 网络号就像村庄的地址，标识计算机所在的网络

### 那么，现在该怎么通信呢？
底层我们依然使用mac地址进行通信，
所以，我们要建立一个通过ip地址找到mac地址的机制。

我们可以通过arp协议来实现这个功能。

### arp协议
arp协议就是用来将ip地址映射到mac地址的协议。

每台计算机都会维护一个arp缓存表，
在自己需要发送基于ip的数据包时，
先发送一个arp请求，询问局域网内谁拥有这个ip地址，
然后对面的计算机会回应自己的mac地址，
这样，发送方就可以将ip地址映射到mac地址，完成通信。

### 网段
像刚才说的，不同的网络就像不同的村庄，
同一个村庄的人通信就像邻居问话，直接喊就行了
但是不同村庄的人通信就需要出这个村庄找邮局了，有时候可能还要问问路。

ip使用网段来划分不同的网络，
同一个网段的计算机可以直接通信，
不同网段的计算机通信就需要通过一个路由器了。

- 两个计算机，怎么样算在同一个网段呢？

如果两台计算机的网络号相同，那么它们就在同一个网段。

### 掩码
掩码就是用来区分网络号和主机号的。

掩码是一个32位的二进制数，与IP地址进行按位与运算，得到网络号。  
例如，子网掩码255.255.255.0表示前24位是网络号，后8位是主机号。  

通过掩码，可以判断两台主机是否在同一网段。

掩码有几种不同的写法：
1. **24（纯数字）**：这是CIDR表示法，表示子网掩码中网络部分的位数。例如，24表示前24位是网络号，后8位是主机号。
2. **255.255.255.0**：这是点分十进制表示法，直接用十进制数表示掩码的每个字节。
3. **11111111.11111111.11111111.00000000**：这是二进制表示法，用二进制数表示掩码的每一位，1表示网络位，0表示主机位。

### 直连和非直连
刚才我们知道了

"同一个村庄的人通信就像邻居问话，直接喊就行了；
但是不同村庄的人通信就需要出这个村庄找邮局了，有时候可能还要问问路。"

具体到计算机网络中，就是：
当我我这台计算机向其他计算机发包时：
- 如果目标ip和我在同一个网段（直连），我就直接发给对方
- 如果目标ip和我不在同一个网段（非直连），我就发给路由器（那个邮政），让路由器帮我转发

直连网络很好理解，就是在同一个局域网内直接用arp找到对方的mac地址进行通信。
非直连网络就需要通过路由器来实现跨网段通信。

## 路由器

### 路由器的作用
路由器是连接不同网络的设备，负责将数据包从一个网络转发到另一个网络。

和交换机的工作其实一样，都是根据地址来转发数据包。

但是路由器的规则复杂的多，因为它要处理不同网络之间的通信，尤其是现在这个全世界的范围。

### 路由
路由，和名字一样，就是给数据包指一条路。
把数据包比作一个人，那么路由就是给这个人指路，让他知道怎么走到目的地。

它实际上的作用，就是根据目标ip地址，决定数据包应该发往哪个端口（刚才说过，路由器最底层的功能，就是转发）。

而下一个目的地，可以是最终的目标计算机，也可以是下一个路由器。
我们一般叫它“下一跳”。

### 静态路由
静态路由是管理员手动配置的路由规则，适用于网络结构比较简单且变化不频繁的场景。
他的命令一般是：
```shell
ip route <目标网络> <子网掩码> <下一跳地址>
```
- 目标网络：表示数据包的目的地网络地址，就像出行的目的地
- 子网掩码：表示目标网络的范围，我想不出什么好的比喻
- 下一跳地址：表示数据包应该发往的下一个路由器地址，就像中途的下一个转车站

> 下一跳地址的注意事项:
> 必须是与本路由器某个端口在同一网段的实际存在的 IP 地址（通常是下一跳路由器的接口 IP）。不能是当前端口不存在或不在同一网段的 IP，否则数据包无法通过二层（MAC）寻址送达，路由表无效。

这样，当路由器收到一个数据包时，它会根据路由表查找匹配的目标网络，然后将数据包转发到指定的下一跳地址。

### 动态路由
动态路由是通过路由协议自动学习和更新路由信息的方式，适用于大型网络和频繁变化的网络环境（现在的互联网用的就很多）。
动态路由协议包括 RIP、OSPF、BGP 等，它们可以根据网络的变化自动调整路由表，确保数据包能够找到最佳路径到达目的地。
主要是基于图论算法来计算最短路径。
比较复杂，这里就不展开讲了。

### 路由表
路由表就是路由器存储路由的地方。
路由表中记录了不同目标网络对应的下一跳地址和出接口。
有点像一个excel表格，里面有很多行，每一行代表一条路由规则。
比如：
| 目标网络       | 子网掩码         | 下一跳地址     | 出接口   |
| :-----: | :------: | :-----: | :----: |
| 192.168.1.1 | 255.255.255.0 | 192.168.2.1  | g0/1 |

> 出接口一般不是在命令里直接写出来的，而是路由器根据“下一跳地址”自动判断出来的。
> 路由器会查找本地哪个网卡（接口）和“下一跳地址”在同一网段，然后自动选择这个接口作为出接口。

### 优先级
当路由器有多条路径可以到达同一个目标网络时，它会根据路由的优先级来选择最佳路径。

优先级通常由路由的类型和管理员设置的度量值决定，是一个int值，越小优先级越高，范围一般是0~255。

静态路由的优先级通常高于动态路由，因为静态路由是管理员手动配置的，通常更可靠。而直连路由的优先级最高，因为它表示直接连接的网络，通信最直接。

一般是：
- 直连路由（优先级最高，通常为0）
- 静态路由（优先级次之，通常为60）
- 动态路由（优先级最低，通常为110或更高，具体取决于协议）

不过，管理员也可以手动调整路由的优先级，以满足特定的网络需求。

## 补充：网卡

我们常说的计算机的IP，mac地址，其实是指计算机上安装的网卡（Network Interface Card，简称NIC）的地址。每台计算机通常至少有一块网卡，用于连接网络。网卡负责将计算机的数据转换为网络信号，并处理接收到的网络数据。

- **网卡的MAC地址**：每块网卡都有一个唯一的MAC地址（物理地址），用于在局域网内进行数据链路层的通信。
- **IP地址与网卡**：IP地址是分配给网卡的逻辑地址，用于网络层的数据包路由。当我们配置计算机的IP地址时，实际上是在为该网卡分配IP地址。如果计算机有多块网卡（如有线和无线），每块网卡可以有不同的IP地址，分别用于不同的网络连接。
- **网卡的作用**：网卡不仅处理IP地址，还负责ARP协议的执行（将IP地址映射到MAC地址），以及数据包的封装和解封装。

在现代计算机中，网卡可以是物理硬件（如PCI网卡）或虚拟的（如虚拟机中的虚拟网卡）。操作系统会为每个网卡分配IP地址，并通过路由表决定数据包的发送路径。