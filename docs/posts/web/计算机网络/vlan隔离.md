---
title: vlan隔离-软件实现网络隔离
date: 2025-12-22
category:
  - web
  - 计算机网络
---

## 我们目前遇到了什么问题？

在上一篇文章中，我们介绍了交换机的作用：它就像一个智能的交通枢纽，把多台计算机连接在一起，实现高效的数据转发。然而，随着网络规模的扩大，我们开始遇到一些棘手的问题。

### 广播风暴与带宽浪费

想象一下，一个公司有财务部和工程部。如果所有电脑都连接到同一个交换机上，那么当工程部进行网络测试时，发出的广播包（比如 ARP 请求）会传播到整个网络，包括财务部的电脑。这不仅浪费带宽，还可能导致“广播风暴”——大量广播包在网络中循环，占用所有可用带宽，使网络瘫痪。

### 物理隔离的成本与复杂性

为了解决安全问题，我们可能想给每个部门单独配备一台交换机。但这意味着：
- **高昂的成本**：每台交换机都要花钱买。
- **线缆管理混乱**：办公室里布满各种线缆，维护困难。
- **扩展性差**：如果部门增多，硬件采购和布线工作量会爆炸式增长。

### 核心问题：物理连接 vs. 逻辑隔离

我们想要物理上连接在一起（省钱、省事），但逻辑上要彻底分开（安全、隔离）。这就像一栋办公楼，虽然大家走同一个大门，但不同公司的员工只能刷卡进入自己的楼层。VLAN（虚拟局域网）正是为了解决这个矛盾而诞生的——通过软件手段。

## 我们现在可以怎么做？

既然问题已经清楚了，那我们该怎么解决呢？让我们从最直观、最朴素的思路开始：给数据帧“贴标签”。

### 最直观的思路：贴标签隔离

想象一下，交换机就像一个邮局，数据包是信件。我们可以给每封信贴上一个颜色标签，比如红色代表财务部，蓝色代表工程部。

- **贴标签**：当数据包进入交换机时，交换机根据发送端口给它贴上对应的标签。比如，从红色的口进，那么它就带有红色的标签，表示它属于财务部。
- **隔离转发**：交换机只允许相同标签的数据包通过对应的端口转发出去。也就是说，红色标签的包只能从其他红色端口出去，蓝色标签的包只能从蓝色端口出去。

这样，即使所有电脑都连在同一台物理交换机上，财务部的电脑发出的包也不会跑到工程部的电脑那里，反之亦然。我们通过软件逻辑实现了“虚拟隔离”，而不需要额外的硬件。

这个方法简单粗暴，但暂时不考虑性能问题——毕竟，我们先要验证思路的可行性。

## 技术实现：接口模式

有了 VLAN Tag，我们就可以在交换机上实现标签隔离了。但交换机上的端口并不是一模一样的，它们有不同的“角色”来处理标签，这就是接口模式。主要的两种模式是 **Access 口** 和 **Trunk 口**（还有混合口，但我们暂时不细讲）。

VLAN最重要的标识就是一个INT值，叫做VLAN ID。每一个VLAN都有一个唯一的VLAN ID，范围是1-4094。

### Access 口：终端设备的入口和出口

Access 口（接入口）是专门用来连接普通电脑、打印机等终端设备的端口。

- **添加标签**：当终端设备发送数据包时，数据包是没有 VLAN Tag 的。Access 口会根据自己的配置，给数据包添加对应的 VLAN ID 标签。（每一个access口会有一个自己的默认VLAN，如果接收到了无vlan的帧，就会给当前帧加上自己的VLAN）
- **移除标签**：接收到了数据帧，要从当前端口发送给PC的时候，会检查当前自己的默认Vlan，如果数据帧的Vlan和自己的默认Vlan一致，就会把标签去掉，然后发送给终端设备。
- **配置命令**：
  ```
  interface GigabitEthernet 0/1    # 进入 GigabitEthernet 0/1 接口的配置模式
  switchport mode access          # 将端口设置为 Access 模式（连接终端设备）
  switchport access vlan 10       # 指定该端口属于 VLAN 10，所有进出数据包都会被打上 VLAN 10 标签
  ```

Access 口解决了终端设备与交换机之间的兼容性问题，确保终端设备无需了解 VLAN 技术，就能正常工作。

### Trunk 口：交换机间的通道

Trunk 口（干道口）是用来连接交换机与交换机（或路由器）的端口。

- **保留标签**：Trunk 口不会添加或移除标签，它会完整保留数据包的 VLAN Tag，确保不同 VLAN 的数据包能正确传递。
- **验证机制**：Trunk 口可以配置允许通过的 VLAN ID，只有匹配的标签才能通过，这样可以防止意外的 VLAN 泄露。
- **Native VLAN（本征Vlan）**：Trunk 口可以配置一个 Native VLAN，主要用于兼容不支持 VLAN 的老旧设备。当接收到不带标签的数据帧时，Trunk 口会给它贴上 自己的 VLAN 的标签。当发送数据帧时，如果数据帧的 VLAN 标签与 Native VLAN 相同，就会移除标签。
- **配置命令**：
  ```
  interface GigabitEthernet 0/24    # 进入 GigabitEthernet 0/24 接口的配置模式
  switchport mode trunk            # 将端口设置为 Trunk 模式（连接交换机或路由器）
  switchport trunk allowed vlan 10,20,30  # 允许 VLAN 10、20、30 的数据包通过，其他 VLAN 被阻塞
  switchport trunk native vlan 1   # 设置 Native VLAN 为 1，用于兼容不支持 VLAN 的设备
  ```

Trunk 口解决了多交换机互联时的 VLAN 扩展问题，让整个网络的 VLAN 逻辑能无缝连接。

### Access 口 vs. Trunk 口的区别

- **连接对象**：Access 口连接终端设备，Trunk 口连接其他交换机或路由器。
- **标签处理**：Access 口添加/移除标签，Trunk 口保留标签。
- **安全性**：Trunk 口有更强的验证机制，避免 VLAN 混淆。
- **应用场景**：Access 口用于网络边缘，Trunk 口用于网络骨干。

通过这两种接口模式，我们的“贴标签隔离”思路就能在实际网络中落地了。

## 隔离了怎么通信？VLAN 间路由

现在，不同 VLAN 之间的设备彻底隔离了，连 Ping 都 Ping 不通。但在实际应用中，我们往往需要让某些设备能跨 VLAN 通信，比如老板需要同时访问财务部和工程部的数据。这时候，我们需要引入 **VLAN 间路由**（Inter-VLAN Routing）。

### 二层隔离，三层互通

VLAN 是二层（数据链路层）的技术，它通过标签隔离了广播域。但通信不仅仅是二层的，还需要三层（网络层）的 IP 路由来实现跨网段通信。

- **二层负责隔离**：VLAN 确保不同部门的数据包不会在二层混在一起。
- **三层负责互通**：通过路由器或三层交换机，让不同 VLAN 的设备能通过 IP 地址通信。

### 单臂路由 (Router on a Stick)

最简单的方法是使用 **单臂路由**：用一根网线（Trunk 口）连接交换机和路由器。

- 路由器的一个接口配置为 Trunk 模式，能接收和发送多个 VLAN 的数据包。
- 当 VLAN 10 的设备想访问 VLAN 20 时：
  - 数据包从交换机发到路由器（带 VLAN 10 标签）。
  - 路由器根据 IP 地址路由，改变标签为 VLAN 20，然后发回交换机。
- 路由器像个“翻译官”，在不同 VLAN 之间转发数据。

这种方法简单，但路由器可能成为瓶颈。

### 三层交换机

现代交换机往往内置路由功能，叫 **三层交换机**。

- 三层交换机内部有路由引擎，能直接在 VLAN 之间转发数据包，无需外部路由器。
- 配置 VLAN 接口（SVI）：每个 VLAN 创建一个虚拟接口，并分配 IP 地址。比如，在交换机上配置：
  ```
  interface vlan 10
  ip address 192.168.10.1 255.255.255.0
  ```
  这给 VLAN 10 分配了一个虚拟 IP 192.168.10.1。
- 从交换机视角看，不同 VLAN 的虚拟 IP 之间被视为直连路由，可以直接转发数据包，无需外部设备。
- 从 PC 视角看，这个虚拟 IP 就是网关（Gateway）。网关的意思是：如果 PC 找了半天还是没找到目标的路由，就把数据包交给网关，让网关帮忙转发。
- 当设备发送数据包到不同 VLAN 时，三层交换机直接路由，速度更快。

通过 VLAN 间路由，我们实现了隔离与互通的平衡：内部隔离，外部可控通信。

## VLAN Tag 详解（补充）

既然我们提到了给数据帧“贴标签”，那这个标签到底是什么？它会在原本的数据链路层帧上添加什么信息？这些信息里的每一个二进制位又代表什么意思？

### 添加的信息：VLAN Tag

VLAN Tag（也叫 802.1Q Tag）是一个 4 字节（32 位）的字段，插入到以太网帧的“源 MAC 地址”和“类型/长度”字段之间。它包含了 VLAN 的所有必要信息。

### Tag 的结构和含义

VLAN Tag 分为两个主要部分：

- **TPID (Tag Protocol Identifier)**：2 字节，固定值 0x8100（十六进制）。这个字段告诉接收设备：“嘿，这是一个 VLAN 标签，不是普通的数据！”
  
- **TCI (Tag Control Information)**：2 字节，包含具体的 VLAN 信息，进一步分为：
  - **PCP (Priority Code Point)**：3 位，表示数据包的优先级（0-7，7 最高）。比如，语音数据可以设高优先级，确保通话不卡。
  - **DEI (Drop Eligible Indicator)**：1 位，表示这个包是否可以被丢弃（0=不能丢，1=可以丢）。用于拥塞控制。
  - **VID (VLAN ID)**：12 位，这就是 VLAN 的唯一标识（1-4094）。比如，10 代表财务部，20 代表工程部。

简单来说，VLAN Tag 就像一个“身份卡”：TPID 是“这是 VLAN 卡”，TCI 是卡上的详细信息（优先级、丢弃标志、VLAN 号）。