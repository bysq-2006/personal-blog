## 系统管理篇（1）

#### 一、查看网络状态

##### 1. 网络接口（网卡）命名

* 板载网卡 eno1
* PCI-E网卡 ens33 
* 无法获取物理信息的PCI-E网卡 enp0s3
* CentOS7使用一致性网络设备命名，当上面都不匹配使用eth0
* 网络接口命名可以通过修改grub文件中的` biosdevname`和` net.ifnames`两个参数进行修改

##### 2. 网络工具包

* net-tools包：ifconfig、route、netstate
* iproute2包：ip、ss

##### 3. 查看网络接口状态

* ip命令

```shell
ip addr ls
ip a # 简写

ip addr show ens32
ip a s ens32 # 简写

# 对照的ifconfig命令
ifconfig
```

##### 4. 查看网关信息

```shell
ip r

# 对照的route命令
route -n # 使⽤ -n 参数不解析主机名
```

#### 二、修改网络配置

##### 1. 主机名

主机名修改完成后注意修改` /etc/hostname`文件。

```shell
hostnamectl set-hostname <主机名>

hostname # 查看
```

##### 2. 修改网络配置

```shell
# 激活
ip link set dev <网卡接口名> up
# 对照的ifup命令

ip link set dev <网卡接口名> down
# 对照的ifdown命令


# 配置网络接口
ip addr add 172.16.182.11/24 dev <网卡接口名>
# 对照的ifconfig命令


# 配置默认网关
ip route add default via 192.168.X.2 dev <网卡接口名> 
Error: either "to" is duplicate, or "192.168.X.2" is a garbage.
# 配置路由
ip route add 192.168.X.0/24（目标地址） via 192.168.X.10（源地址） dev <网卡接口名> 
# 对照的route命令

```

##### 3. 多网卡聚合

* 为虚拟机添加网卡，注意保持和现有网卡选择**相同**类型
* 确认系统支持 Bonding

```shell
lsmod | grep bonding

# 如果无输出，加载模块
modprobe bonding
```

* 创建 Bonding 配置文件

创建 Bonding 配置文件（以 `bond0` 为例）：

```shell
vi /etc/sysconfig/network-scripts/ifcfg-bond0

type="Bond"
BOOTPROTO="none"
NAME="bond0"
DEVICE="bond0"
ONBOOT="yes"
IPADDR="192.168.200.20"
PREFIX="24"
GATEWAY="192.168.200.2"
DNS1="192.168.200.2"
BONDING_OPTS="mode=1 miimon=50 primary=ens33 fail_over_mac=active"
```

* 配置物理网卡

编辑物理网卡配置文件

如 `ens33` 

```shell
vi /etc/sysconfig/network-scripts/ifcfg-ens33

TYPE="Ethernet"
BOOTPROTO="none"
NAME="ens33"
DEVICE="ens33"
ONBOOT="yes"
MASTER="bond0"
SLAVE="yes"
```

`ens35`

```shell
vi /etc/sysconfig/network-scripts/ifcfg-ens35

TYPE="Ethernet"
BOOTPROTO="none"
NAME="ens35"
DEVICE="ens35"
ONBOOT="yes"
MASTER="bond0"
SLAVE="yes"
```

* 重启网络服务

```shell
systemctl restart network

# 如遇异常，可考虑关闭NetworkManager服务
```

* 测试

```shell
cat /proc/net/bonding/bond0

# 查看激活的物理网卡
Currently Active Slave: ens33

# 禁用该网卡
ip link set dev ens33 down

# 观察是否能自动切换？网络是否会终端
```





#### 三、修改网络配置文件

##### 1. 网卡配置文件

* 文件位置：` /etc/sysconfig/network-scripts/ifcfg-<网络接口名>`

```properties
BOOTPROTO=static # 还有dhcp,none
ONBOOT=yes
IPADDR=192.168.159.10
NETMASK=255.255.255.0 # 也可以使用PREFIX=24,24为掩码位数
GATEWAY=192.168.159.2
DNS1=192.168.159.2 # 最多可配置三个DNS服务器
```

* 网络服务管理程序

  * 分为两种：SysV 和 systemd
  * 服务分别为：network，NetworkManager

* 修改配置文件后，必须重启服务，才能生效。

  ```shell
  systemctl restart network
  ```

##### 2. hosts配置文件

* 文件位置：` /etc/hosts`

  ```shell
  <ip> <主机名>
  192.168.159.10 mall
  ```


#### 四、NetworkManager

nmcli 四类常用命令：n、g、c、d

1. ##### nmcli networking

* 显示 NetworkManager 是否接管网络设置

```shell
nmcli n
```

* 查看网络连接状态：

```shell
nmcli n c
```

网络连接状态共有五种：full、limited（连网，但无法上网）、portal（连网，但需要认证登录后才能上网）、none（没连网）和 unknown。

* 开启、关闭网络连接：

```shell
nmcli n on
nmcli n off
```

2. ##### nmcli general

* 显示系统网络状态：

```shell
nmcli g
```

* 显示主机名：

```shell
nmcli g h
```

* 更改主机名:

```shell
nmcli g h 新的主机名
```

修改主机名后，需要重启 NetworkManager。

3. ##### nmcli connection

* 显示所有网络连接的信息：

```shell
nmcli c
nmcli c s -a # nmcli c show --active
```

* 显示某一特定连接的详细信息（以 ens33 为例）：

```shell
nmcli c s ens33
```

* 启动/关闭指定连接：

```shell
nmcli c up ens33
nmcli c down ens33
```

* 修改连接：

语法：`nmcli c modify ens33  [ + | - ]选项 选项值`

```shell
nmcli c m ens33 ipv4.address 192.168.159.10/24  # 修改 IP 地址和子网掩码
nmcli c m ens33 ipv4.method manual             # 修改为静态配置，默认是 auto. 必须先修改 ipv4.address，然后才能修改 ipv4.method
nmcli c m ens33 ipv4.gateway 192.168.159.2      # 修改默认网关
nmcli c m ens33 ipv4.dns 192.168.159.2          # 修改 DNS
nmcli c m ens33 +ipv4.dns 114.114.114.114      # 添加一个 DNS
nmcli c m ens33 connection.autoconnect yes     # 开机启动
```

用空引号`""`代替选项的值，可将选项设回默认值。注意修改后需要通过`nmcli c up ens33`启动配置生效。

* 新增连接：

语法：`nmcli c add type 连接类型 选项 选项值`

type 为必选项，我们通常用到的是`ethernet`。

```shell
nmcli c a type ethernet con-name ens36 ifname ens36
```

* 删除指定连接：

```shell
nmcli c delete ens33 # delete 不可简写为 d，否则与 down 冲突，但可以简写为 de
```

* 重载配置文件：

```shell
nmcli c r # 重载所有连接的配置文件
nmcli c l ifcfg-ens33 # 重载某一指定连接的配置文件
```

4. ##### nmcli device

* 显示所有网络接口设备的状态：

```shell
nmcli d # nmcli device status
```

* 显示设备的详细信息：

```shell
nmcli d sh # show 不可简写为 s，否则与 status 冲突，但可以简写为 sh
nmcli d sh ens33 # 显示某一特定设备的详细信息
```

* 连接设备

```shell
nmcli d c ens33 # nmcli d connect ens33
```

* 断开设备

```shell
nmcli d d ens33 # nmcli d disconnect ens33
```

* 更新设备信息

```shell
nmcli d r ens33 # nmcli d reapply ens33
```

只有在设备处于连接状态，才可以更新设备。

#### 五、sshd服务

sshd服务可以提供远程登录服务

1. 登录

```shell
# ssh 用户名@主机
ssh root@centos2
```

* 主机可以使用IP或者主机名

2. ssh免密登录

* 免密可以方便集群运维，避免频繁输入密码
* 免密实际是公开密码体系的运用
  * 公开密码体系
    * 每个用户有一对密码：私钥和公钥，私钥只有自己保存，公钥任何人可以获得
    * 使用自己私钥加密的信息只能有自己的公钥解密，反正亦然

```shell
ssh-keygen # 一直回车，生产私钥和公钥

ssh-copy-id centos2 # 将自己的公钥复制给centos2；centos2即可使用公钥验证登录者身份
```

3. scp

```shell
# scp 源文件 用户@主机:目标地址
scp test.txt root@centos2:/root
```

* 主机可以使用IP或者主机名
* 目标地址使用绝对地址
* 如果当前用户和远程登录用户是相同的，可以省略
